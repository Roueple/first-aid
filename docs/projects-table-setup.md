# Projects Table Setup Guide

## Overview

The Projects table is a master table that stores project information and is connected to the Findings table via `projectName` and `projectType` fields.

## Table Structure

| Column | Type | Description |
|--------|------|-------------|
| No. | Display Only | Sequential row number (not stored, always starts from 1) |
| ID | String (7-digit) | Auto-generated from SH-Project-Type hash |
| SH | String | Subholding name |
| Project | String | Project name (unique, used as FK in Findings) |
| Total Finding | Number | Count of findings (calculated from Findings table) |
| Non-Finding | Number | Count of non-findings (calculated from Findings table) |
| Type | String | Project type classification |
| Subtype | String | Project subtype |
| Description | String | Project description |

## Key Features

### 1. Auto-Generated 7-Digit ID
- Generated by hashing: `SH-ProjectName-Type`
- Always 7 digits (1000000-9999999)
- Deterministic (same input = same ID)
- Stored in `projectId` field

### 2. Row Numbers
- **Not stored in database**
- Displayed as sequential numbers (1, 2, 3...)
- **Not affected by filters or sorting**
- Always shows the current row position in the filtered/sorted view

### 3. Finding Counts
- `finding`: Count of records in Findings table where `projectName` matches
- `nonFinding`: Count of non-finding records
- **Automatically calculated** from actual Findings data during import
- Can be recalculated using `ProjectService.recalculateProjectStats()`

## Import from Excel

### Excel File Structure
- **File**: `raw_data.xlsx`
- **Sheet**: `Proyek`
- **Columns**: No, SH, Project, Total Finding, Non-Finding, Type, Subtype, Description

### Running the Import

```bash
# Install dependencies if needed
npm install xlsx firebase-admin

# Run the import script
node scripts/import-projects-from-excel.mjs
```

### Import Process
1. Reads "Proyek" sheet from `raw_data.xlsx`
2. For each row:
   - Generates 7-digit project ID
   - Queries Findings table to count actual findings
   - Creates or updates project record
3. Outputs summary of created/updated/skipped records

### Important Notes
- **Total Finding and Non-Finding columns in Excel are ignored**
- Counts are calculated from actual Findings data
- Existing projects are updated (not duplicated)
- Projects are matched by `projectName` (unique)

## Usage in Code

### Import Projects
```typescript
// Run the import script
node scripts/import-projects-from-excel.mjs
```

### Display Projects Table
```tsx
import ProjectsTable from '../components/ProjectsTable';

function MyPage() {
  return (
    <ProjectsTable 
      onProjectSelect={(project) => {
        console.log('Selected:', project);
      }}
    />
  );
}
```

### Query Projects
```typescript
import ProjectService from '../services/ProjectService';

const projectService = new ProjectService();

// Get all projects
const projects = await projectService.getAllProjects();

// Get project by name
const project = await projectService.getProjectByName('Project ABC');

// Get projects by subholding
const shProjects = await projectService.getProjectsBySubholding('SH-001');

// Recalculate stats for a project
await projectService.recalculateProjectStats(projectId);

// Recalculate all project stats
await projectService.recalculateAllProjectStats();
```

## Relationship with Findings

### Foreign Key
- Findings table has `projectName` field
- Must match a project's `projectName` in Projects table
- Validated on finding creation

### Automatic Updates
- When a finding is created/updated/deleted
- Project statistics are automatically recalculated
- Ensures counts are always accurate

### Validation
```typescript
// Before creating a finding, validate project exists
const projectExists = await projectService.validateProjectExists(
  'Project ABC',
  'Audit'
);

if (!projectExists) {
  throw new Error('Project does not exist');
}
```

## UI Features

### Sorting
- Click any column header to sort
- Click again to reverse sort direction
- Arrow indicators show current sort

### Filtering
- Search box filters across all text fields
- Real-time filtering as you type
- Shows count of filtered results

### Row Numbers
- Always sequential (1, 2, 3...)
- Not affected by sorting or filtering
- Shows position in current view

### Visual Indicators
- Finding count: Red badge
- Non-Finding count: Green badge
- Hover effect on rows
- Clickable rows for selection

## Database Schema

```typescript
interface Project {
  id: string;              // Firestore doc ID
  projectId: string;       // 7-digit auto-generated ID
  sh: string;              // Subholding
  projectName: string;     // Unique project name
  projectType: string;     // Project type
  type: string;            // Type classification
  subtype: string;         // Subtype
  description: string;     // Description
  finding: number;         // Finding count
  nonFinding: number;      // Non-finding count
  total: number;           // Total count
  isActive: boolean;       // Active status
  createdAt: Timestamp;
  updatedAt: Timestamp;
  createdBy: string;
}
```

## Maintenance

### Recalculate All Stats
If finding counts get out of sync:

```bash
# Create a maintenance script
node scripts/recalculate-project-stats.mjs
```

Or use the service directly:
```typescript
const projectService = new ProjectService();
await projectService.recalculateAllProjectStats();
```

### Re-import from Excel
To update projects from Excel:
```bash
node scripts/import-projects-from-excel.mjs
```
- Existing projects will be updated
- New projects will be created
- Counts will be recalculated from Findings

## Troubleshooting

### Import Issues
- **Sheet not found**: Check sheet name is exactly "Proyek"
- **Missing columns**: Verify Excel has all required columns
- **Firebase errors**: Check credentials in `.test-credentials.json`

### Count Mismatches
- Run recalculate stats script
- Check Findings have correct `projectName` values
- Verify project names match exactly (case-sensitive)

### UI Issues
- **No data showing**: Check Firebase connection
- **Slow loading**: Add indexes for `projectName` queries
- **Filter not working**: Clear browser cache

## Next Steps

1. Run the import script to populate projects
2. Add ProjectsTable component to your UI
3. Set up automatic stat recalculation (optional)
4. Create indexes for better query performance
